<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blockchain</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { 
      color-scheme: light;
    }

    html, body {
      background: #ffffff;
      color: #111111;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
    }

    body { 
      margin: 2rem;
    }

    h1 { 
      margin: 0 0 0.5rem 0; 
    }

    .controls {
      display: flex; 
      flex-direction: column;
      flex-wrap: wrap; 
      gap: 1rem; 
      margin-top: 2rem;
    margin-bottom: 2rem;

    }

    input[type="text"] { 
      padding: 0.5rem; 
      min-width: 320px; 
    }

    button, select, label, input[type="file"] { 
      padding: 0.5rem; 
    }

    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); 
      gap: 1rem; 
    }

    .card {
      border: 1px solid #e5e7eb;         
      border-radius: 12px;
      padding: 1rem;
      background: #ffffff;                  
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
    }

    .badge {
      font-size: 0.85rem; padding: 0.2rem 0.5rem; border-radius: 999px;
      background: #f3f4f6;                 /* light gray pill */
      display: inline-block;
    }

    .muted { 
      opacity: 0.8; 
    }

    .mono { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
      word-break: break-all; 
    }

    .invalid { 
      border-color: #dc2626; 
      background: #fee2e2; 
    }

    .ok { 
      border-color: #e5e7eb; 
    }                          

    .row { 
      display: grid; 
      grid-template-columns: 140px 1fr; 
      gap: 0.5rem; 
      margin: 0.25rem 0; 
    }

    footer { 
      margin-top: 2rem; 
      opacity: 0.8; 
      font-size: 0.9rem; 
    }

  </style>
</head>
<body>
  <h1>Blockchain</h1>
  <div class="muted">Difficulty: <span id="difficulty">{{ difficulty }}</span></div>

  <div class="controls">
    <div class="">
      <input id="dataInput" type="text" placeholder="Optional data (e.g., transactions JSON or a note)" />
      <button id="mineBtn">Mine</button>
    </div>

    <div class="">
      <select id="fmt">
        <option value="json">JSON</option>
        <option value="yaml">YAML</option>
        <option value="txt">TXT</option>
      </select>
      <button id="downloadBtn">Download</button>
    </div>

    <div class="">
      <label class="muted">Validate:&nbsp;<input id="upload" type="file" /></label>
      <button id="validateBtn">Validate</button>
    </div>
  </div>

  <div id="status" class="muted"></div>

  <h2>Blockchain</h2>
  <div id="chain" class="grid"></div>

  <script>
    const chainEl = document.getElementById("chain");
    const statusEl = document.getElementById("status");

    function row(label, value, mono=false) {
      const div = document.createElement("div");
      div.className = "row";
      const l = document.createElement("div");
      l.textContent = label + ":";
      const v = document.createElement("div");
      v.textContent = typeof value === "string" ? value : JSON.stringify(value);
      if (mono) v.className = "mono";
      div.appendChild(l); div.appendChild(v);
      return div;
    }

    function renderChain(data, invalidFrom=null) {
      chainEl.innerHTML = "";
      data.chain.forEach((b, i) => {
        const card = document.createElement("div");
        card.className = "card " + ((invalidFrom !== null && i >= invalidFrom) ? "invalid" : "ok");

        const head = document.createElement("div");
        head.innerHTML = `<span class="badge">Block #${b.index}</span>`;
        card.appendChild(head);

        card.appendChild(row("Timestamp", b.timestamp));
        card.appendChild(row("Previous Hash", b.prev_hash, true));
        card.appendChild(row("Hash", b.hash, true));
        card.appendChild(row("Data", typeof b.data === "string" ? b.data : JSON.stringify(b.data)));
        card.appendChild(row("Nonce", b.nonce));

        chainEl.appendChild(card);
      });
    }

    async function refresh() {
      const res = await fetch("/chain");
      const data = await res.json();
      renderChain(data, null);
      statusEl.textContent = `Length: ${data.length}`;
      document.getElementById("difficulty").textContent = data.difficulty;
    }

    document.getElementById("mineBtn").onclick = async () => {
      const dataField = document.getElementById("dataInput").value.trim();
      statusEl.textContent = "Mining on server...";
      const res = await fetch("/mine", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: dataField || null })
      });
      const out = await res.json();
      if (out.ok) {
        statusEl.textContent = `Mined block #${out.block.index} on server`;
        refresh();
      } else {
        statusEl.textContent = "Mine failed";
      }
    };

    document.getElementById("downloadBtn").onclick = () => {
      const fmt = document.getElementById("fmt").value;
      window.location.href = `/download?format=${encodeURIComponent(fmt)}`;
    };

    document.getElementById("validateBtn").onclick = async () => {
      const f = document.getElementById("upload").files[0];
      if (!f) { alert("Choose a file first."); return; }
      const fd = new FormData();
      fd.append("file", f);
      statusEl.textContent = "Validating...";
      const res = await fetch("/validate", { method: "POST", body: fd });
      if (!res.ok) {
        statusEl.textContent = "Validation failed to run.";
        return;
      }
      const data = await res.json();
      statusEl.textContent = data.ok ? "Uploaded chain is VALID ✅" : `INVALID from block index ${data.invalid_from} ❌`;
      renderChain(data, data.invalid_from);
    };

    refresh();
  </script>
</body>
</html>
